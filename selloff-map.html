<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Land Selloff Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        #map { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 100%; 
        }

        .controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1;
        }
        .control-button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            margin-left: 5px;
            cursor: pointer;
            font-size: 11px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }
        .control-button:hover {
            background: rgba(255, 255, 255, 1);
        }
        .control-button.active {
            background: #007cbf;
            color: white;
        }
        .layer-controls {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font: 12px/18px 'Helvetica Neue', Arial, sans-serif;
            padding: 15px;
            position: absolute;
            right: 15px;
            z-index: 1;
            min-width: 180px;
        }
        .layer-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .layer-toggle:last-child {
            margin-bottom: 0;
        }
        .layer-toggle input[type="checkbox"] {
            margin-right: 8px;
        }
        .layer-toggle label {
            color: #555;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .color-pip {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            display: inline-block;
        }
        .color-pip.stroke {
            border: 2px solid;
            background: transparent;
        }
        .color-pip.fill {
            opacity: 0.7;
        }
        
        /* Terrain Editor Controls */
        .terrain-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
            width: 280px;
        }
        .terrain-controls.collapsed {
            width: auto;
        }
        .terrain-controls.collapsed .control-content {
            display: none;
        }
        .control-header {
            padding: 12px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .control-content {
            padding: 15px;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group:last-child {
            margin-bottom: 0;
        }
        .control-group h4 {
            margin: 0 0 10px 0;
            font-size: 13px;
            font-weight: bold;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .control-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .control-item label {
            font-size: 11px;
            color: #666;
            margin-right: 10px;
            min-width: 80px;
        }
        .control-item input[type="range"] {
            flex: 1;
            margin: 0 8px;
        }
        .control-item input[type="color"] {
            width: 30px;
            height: 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .control-item input[type="text"] {
            width: 60px;
            padding: 2px 4px;
            font-size: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .control-item select {
            flex: 1;
            padding: 4px 6px;
            font-size: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            margin-left: 8px;
        }
        .control-item input[type="checkbox"] {
            margin-right: 8px;
        }
        .range-value {
            font-size: 10px;
            color: #999;
            min-width: 30px;
            text-align: right;
        }
        .color-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .toggle-btn {
            background: #007cbf;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
        }
        .toggle-btn:hover {
            background: #005a8b;
        }
    </style>
</head>
<body>

<div id='map'></div>

<!-- Terrain Editor Controls -->
<div class="terrain-controls" id="terrain-controls">
    <div class="control-header" onclick="toggleTerrainControls()">
        <span>Terrain Controls</span>
        <span id="collapse-icon">âˆ’</span>
    </div>
    <div class="control-content">
        <!-- Terrain Settings -->
        <div class="control-group">
            <h4>Terrain</h4>
            <div class="control-item">
                <input type="checkbox" id="terrain-toggle" checked>
                <label for="terrain-toggle">Enable 3D Terrain</label>
            </div>
            <div class="control-item">
                <label>Exaggeration</label>
                <input type="range" id="terrain-exaggeration" min="0.1" max="5" step="0.1" value="3">
                <span class="range-value" id="terrain-exaggeration-value">3</span>
            </div>
        </div>

        <!-- Hillshade Settings -->
        <div class="control-group">
            <h4>Hillshade</h4>
            <div class="control-item">
                <input type="checkbox" id="hillshade-toggle">
                <label for="hillshade-toggle">Enable Hillshade</label>
            </div>
            <div class="control-item">
                <label>Shadow</label>
                <div class="color-group">
                    <input type="color" id="hillshade-shadow-color" value="#5a3f2b">
                    <input type="text" id="hillshade-shadow-color-text" value="#5a3f2b">
                </div>
            </div>
            <div class="control-item">
                <label>Highlight</label>
                <div class="color-group">
                    <input type="color" id="hillshade-highlight-color" value="#f9e29c">
                    <input type="text" id="hillshade-highlight-color-text" value="#f9e29c">
                </div>
            </div>
            <div class="control-item">
                <label>Illumination</label>
                <input type="range" id="hillshade-illumination" min="0" max="360" step="1" value="240">
                <span class="range-value" id="hillshade-illumination-value">240</span>
            </div>
            <div class="control-item">
                <label>Exaggeration</label>
                <input type="range" id="hillshade-exaggeration" min="0" max="2" step="0.1" value="0.8">
                <span class="range-value" id="hillshade-exaggeration-value">0.8</span>
            </div>
        </div>

        <!-- Sky Settings -->
        <div class="control-group">
            <h4>Sky & Atmosphere</h4>
            <div class="control-item">
                <input type="checkbox" id="sky-toggle" checked>
                <label for="sky-toggle">Enable Sky</label>
            </div>
            <div class="control-item">
                <label>Sun Intensity</label>
                <input type="range" id="sky-sun-intensity" min="1" max="50" step="1" value="15">
                <span class="range-value" id="sky-sun-intensity-value">15</span>
            </div>
            <div class="control-item">
                <label>Sun Position X</label>
                <input type="range" id="sky-sun-x" min="-1" max="1" step="0.1" value="0">
                <span class="range-value" id="sky-sun-x-value">0</span>
            </div>
            <div class="control-item">
                <label>Sun Position Y</label>
                <input type="range" id="sky-sun-y" min="-1" max="1" step="0.1" value="0">
                <span class="range-value" id="sky-sun-y-value">0</span>
            </div>
        </div>

        <!-- Fog Settings -->
        <div class="control-group">
            <h4>Fog</h4>
            <div class="control-item">
                <input type="checkbox" id="fog-toggle">
                <label for="fog-toggle">Enable Fog</label>
            </div>
            <div class="control-item">
                <label>Color</label>
                <div class="color-group">
                    <input type="color" id="fog-color" value="#ffffff">
                    <input type="text" id="fog-color-text" value="#ffffff">
                </div>
            </div>
            <div class="control-item">
                <label>Horizon Blend</label>
                <input type="range" id="fog-horizon-blend" min="0" max="1" step="0.1" value="0.5">
                <span class="range-value" id="fog-horizon-blend-value">0.5</span>
            </div>
            <div class="control-item">
                <label>Distance</label>
                <input type="range" id="fog-distance" min="1" max="100" step="1" value="50">
                <span class="range-value" id="fog-distance-value">50</span>
            </div>
        </div>

        <!-- Map Style Settings -->
        <div class="control-group">
            <h4>Map Style</h4>
            <div class="control-item">
                <label>Base Style</label>
                <select id="map-style-select">
                    <option value="mapbox://styles/mapbox/outdoors-v12" selected>Outdoors</option>
                    <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
                    <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite Streets</option>
                    <option value="mapbox://styles/mapbox/light-v11">Light</option>
                    <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
                    <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
                    <option value="mapbox://styles/mapbox/navigation-day-v1">Navigation Day</option>
                    <option value="mapbox://styles/mapbox/navigation-night-v1">Navigation Night</option>
                </select>
            </div>
        </div>

        <!-- Layer Styling -->
        <div class="control-group">
            <h4>Layer Styling</h4>
            
            <!-- BLM All Styling -->
            <div class="control-item">
                <label>BLM All Color</label>
                <div class="color-group">
                    <input type="color" id="blm-all-color" value="#FFD700">
                    <input type="text" id="blm-all-color-text" value="#FFD700">
                </div>
            </div>
            <div class="control-item">
                <label>BLM All Opacity</label>
                <input type="range" id="blm-all-opacity" min="0" max="1" step="0.1" value="0.6">
                <span class="range-value" id="blm-all-opacity-value">0.6</span>
            </div>

            <!-- FS All Styling -->
            <div class="control-item">
                <label>FS All Color</label>
                <div class="color-group">
                    <input type="color" id="fs-all-color" value="#228B22">
                    <input type="text" id="fs-all-color-text" value="#228B22">
                </div>
            </div>
            <div class="control-item">
                <label>FS All Opacity</label>
                <input type="range" id="fs-all-opacity" min="0" max="1" step="0.1" value="0.6">
                <span class="range-value" id="fs-all-opacity-value">0.6</span>
            </div>

            <!-- BLM Sellable Styling -->
            <div class="control-item">
                <label>BLM Sellable Color</label>
                <div class="color-group">
                    <input type="color" id="blm-sellable-color" value="#B8860B">
                    <input type="text" id="blm-sellable-color-text" value="#B8860B">
                </div>
            </div>
            <div class="control-item">
                <label>BLM Sellable Width</label>
                <input type="range" id="blm-sellable-width" min="0.5" max="5" step="0.5" value="1">
                <span class="range-value" id="blm-sellable-width-value">1</span>
            </div>

            <!-- FS Sellable Styling -->
            <div class="control-item">
                <label>FS Sellable Color</label>
                <div class="color-group">
                    <input type="color" id="fs-sellable-color" value="#006400">
                    <input type="text" id="fs-sellable-color-text" value="#006400">
                </div>
            </div>
            <div class="control-item">
                <label>FS Sellable Width</label>
                <input type="range" id="fs-sellable-width" min="0.5" max="5" step="0.5" value="1">
                <span class="range-value" id="fs-sellable-width-value">1</span>
            </div>
        </div>
    </div>
</div>

<div class='controls'>
    <button class='control-button active' onclick='toggleTerrain()' id='terrain-btn'>3D Terrain</button>
</div>

<div class="layer-controls">
    <div class="layer-toggle">
        <input type="checkbox" id="toggle-blm-sellable" checked>
        <label for="toggle-blm-sellable">
            <span class="color-pip stroke" style="border-color: #B8860B;"></span>
            BLM Sellable
        </label>
    </div>
    <div class="layer-toggle">
        <input type="checkbox" id="toggle-blm-all" checked>
        <label for="toggle-blm-all">
            <span class="color-pip fill" style="background-color: #FFD700;"></span>
            BLM All
        </label>
    </div>
    <div class="layer-toggle">
        <input type="checkbox" id="toggle-fs-sellable" checked>
        <label for="toggle-fs-sellable">
            <span class="color-pip stroke" style="border-color: #006400;"></span>
            FS Sellable
        </label>
    </div>
    <div class="layer-toggle">
        <input type="checkbox" id="toggle-fs-all" checked>
        <label for="toggle-fs-all">
            <span class="color-pip fill" style="background-color: #228B22;"></span>
            FS All
        </label>
    </div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoiam9ubml3YWxrZXIiLCJhIjoiY2loeG82cWplMDA4N3cxa3MzZXU2N2JpYSJ9.H6vPKI0UKLv733mSCXh2Lw';

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/outdoors-v12', // Using public Mapbox style
    center: [-120, 45], // Center on western US
    zoom: 4, // Zoom out to see more data
    pitch: 60,
    bearing: 0,
    antialias: true
});

// Add terrain and sky
map.on('style.load', () => {
    map.addSource('mapbox-dem', {
        type: 'raster-dem',
        url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
        tileSize: 512,
        maxzoom: 14
    });
    
    map.setTerrain({ 
        source: 'mapbox-dem', 
        exaggeration: 3
    });
    
    map.addLayer({
        id: 'sky',
        type: 'sky',
        paint: {
            'sky-type': 'atmosphere',
            'sky-atmosphere-sun': [0.0, 0.0],
            'sky-atmosphere-sun-intensity': 15
        }
    });
});

let terrainEnabled = true;

function toggleTerrain() {
    const btn = document.getElementById('terrain-btn');
    const terrainToggle = document.getElementById('terrain-toggle');
    
    if (terrainEnabled) {
        map.setTerrain(null);
        btn.textContent = '2D Map';
        btn.classList.remove('active');
        terrainEnabled = false;
        if (terrainToggle) terrainToggle.checked = false;
    } else {
        const exaggeration = document.getElementById('terrain-exaggeration') ? 
            parseFloat(document.getElementById('terrain-exaggeration').value) : 3;
        map.setTerrain({ 
            source: 'mapbox-dem', 
            exaggeration: exaggeration
        });
        btn.textContent = '3D Terrain';
        btn.classList.add('active');
        terrainEnabled = true;
        if (terrainToggle) terrainToggle.checked = true;
    }
}

map.on('load', () => {
    // Add vector tile sources
    // Note: Serve your .mbtiles files with tileserver-gl:
    // npm install -g tileserver-gl && tileserver-gl vector-tiles/
    
    map.addSource('blm-all', {
        type: 'vector',
        tiles: ['http://localhost:8080/data/blm_all_hires/{z}/{x}/{y}.pbf'],
        minzoom: 0,
        maxzoom: 14
    });
    
    map.addSource('fs-all', {
        type: 'vector',
        tiles: ['http://localhost:8080/data/fs_all_hires/{z}/{x}/{y}.pbf'],
        minzoom: 0,
        maxzoom: 14
    });
    
    map.addSource('blm-sellable', {
        type: 'vector',
        tiles: ['http://localhost:8080/data/blm_sellable_hires/{z}/{x}/{y}.pbf'],
        minzoom: 0,
        maxzoom: 14
    });
    
    map.addSource('fs-sellable', {
        type: 'vector',
        tiles: ['http://localhost:8080/data/fs_sellable_hires/{z}/{x}/{y}.pbf'],
        minzoom: 0,
        maxzoom: 14
    });
    
    // Add fill layers (all lands with multiply blend)
    map.addLayer({
        id: 'blm-all-fill',
        type: 'fill',
        source: 'blm-all',
        'source-layer': 'blm_all',
        paint: {
            'fill-color': '#FFD700', // Gold
            'fill-opacity': 0.6
        },
        layout: {
            'visibility': 'visible'
        }
    }, 'waterway-label'); // Insert before labels
    
    map.addLayer({
        id: 'fs-all-fill',
        type: 'fill',
        source: 'fs-all',
        'source-layer': 'fs_all',
        paint: {
            'fill-color': '#228B22', // Forest Green
            'fill-opacity': 0.6
        },
        layout: {
            'visibility': 'visible'
        }
    }, 'waterway-label');
    
    // Add stroke layers (sellable lands)
    map.addLayer({
        id: 'blm-sellable-stroke',
        type: 'line',
        source: 'blm-sellable',
        'source-layer': 'blm_sellable',
        paint: {
            'line-color': '#B8860B', // Dark Gold
            'line-width': 1,
            'line-opacity': 0.8
        },
        layout: {
            'visibility': 'visible'
        }
    });
    
    map.addLayer({
        id: 'fs-sellable-stroke',
        type: 'line',
        source: 'fs-sellable',
        'source-layer': 'fs_sellable',
        paint: {
            'line-color': '#006400', // Dark Green
            'line-width': 1,
            'line-opacity': 0.8
        },
        layout: {
            'visibility': 'visible'
        }
    });
    
    // Add click events for popups
    map.on('click', 'blm-all-fill', (e) => {
        const props = e.features[0].properties;
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
                <h3>BLM Land</h3>
                <p><strong>Name:</strong> ${props.NAME || 'N/A'}</p>
                <p><strong>Acres:</strong> ${props.Acres ? Number(props.Acres).toLocaleString() : 'N/A'}</p>
            `)
            .addTo(map);
    });
    
    map.on('click', 'fs-all-fill', (e) => {
        const props = e.features[0].properties;
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
                <h3>Forest Service Land</h3>
                <p><strong>Name:</strong> ${props.NAME || props.FORESTNAME || 'N/A'}</p>
                <p><strong>Acres:</strong> ${props.Acres ? Number(props.Acres).toLocaleString() : 'N/A'}</p>
            `)
            .addTo(map);
    });
    
    map.on('click', 'blm-sellable-stroke', (e) => {
        const props = e.features[0].properties;
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
                <h3>BLM Sellable Land</h3>
                <p><strong>Name:</strong> ${props.NAME || 'N/A'}</p>
                <p><strong>Acres:</strong> ${props.Acres ? Number(props.Acres).toLocaleString() : 'N/A'}</p>
                <p style="color: #B8860B;"><strong>Available for Sale</strong></p>
            `)
            .addTo(map);
    });
    
    map.on('click', 'fs-sellable-stroke', (e) => {
        const props = e.features[0].properties;
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
                <h3>Forest Service Sellable Land</h3>
                <p><strong>Name:</strong> ${props.NAME || props.FORESTNAME || 'N/A'}</p>
                <p><strong>Acres:</strong> ${props.Acres ? Number(props.Acres).toLocaleString() : 'N/A'}</p>
                <p style="color: #006400;"><strong>Available for Sale</strong></p>
            `)
            .addTo(map);
    });
    
    // Change cursor on hover
    ['blm-all-fill', 'fs-all-fill', 'blm-sellable-stroke', 'fs-sellable-stroke'].forEach(layer => {
        map.on('mouseenter', layer, () => { 
            map.getCanvas().style.cursor = 'pointer'; 
        });
        map.on('mouseleave', layer, () => { 
            map.getCanvas().style.cursor = ''; 
        });
    });
    
    // Layer toggles
    document.getElementById('toggle-blm-all').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('blm-all-fill', 'visibility', visibility);
    });
    
    document.getElementById('toggle-fs-all').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('fs-all-fill', 'visibility', visibility);
    });
    
    document.getElementById('toggle-blm-sellable').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('blm-sellable-stroke', 'visibility', visibility);
    });
    
    document.getElementById('toggle-fs-sellable').addEventListener('change', function(e) {
        const visibility = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('fs-sellable-stroke', 'visibility', visibility);
    });
});

// Navigation controls
map.addControl(new mapboxgl.NavigationControl());
map.addControl(new mapboxgl.FullscreenControl());

// Geolocate control
map.addControl(new mapboxgl.GeolocateControl({
    positionOptions: {
        enableHighAccuracy: true
    },
    trackUserLocation: true,
    showUserHeading: true
}));

// Terrain Editor Functions
function toggleTerrainControls() {
    const controls = document.getElementById('terrain-controls');
    const icon = document.getElementById('collapse-icon');
    
    if (controls.classList.contains('collapsed')) {
        controls.classList.remove('collapsed');
        icon.textContent = 'âˆ’';
    } else {
        controls.classList.add('collapsed');
        icon.textContent = '+';
    }
}

// Initialize range input displays
document.addEventListener('DOMContentLoaded', function() {
    const rangeInputs = document.querySelectorAll('input[type="range"]');
    rangeInputs.forEach(input => {
        const valueDisplay = document.getElementById(input.id + '-value');
        if (valueDisplay) {
            valueDisplay.textContent = input.value;
            input.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
            });
        }
    });
    
    // Color input synchronization
    const colorInputs = document.querySelectorAll('input[type="color"]');
    colorInputs.forEach(input => {
        const textInput = document.getElementById(input.id + '-text');
        if (textInput) {
            input.addEventListener('input', () => {
                textInput.value = input.value;
            });
            textInput.addEventListener('input', () => {
                if (/^#[0-9A-F]{6}$/i.test(textInput.value)) {
                    input.value = textInput.value;
                }
            });
        }
    });
});

// Terrain Controls
document.getElementById('terrain-toggle').addEventListener('change', function(e) {
    if (e.target.checked) {
        const exaggeration = parseFloat(document.getElementById('terrain-exaggeration').value);
        map.setTerrain({ source: 'mapbox-dem', exaggeration: exaggeration });
    } else {
        map.setTerrain(null);
    }
});

document.getElementById('terrain-exaggeration').addEventListener('input', function(e) {
    if (document.getElementById('terrain-toggle').checked) {
        map.setTerrain({ source: 'mapbox-dem', exaggeration: parseFloat(e.target.value) });
    }
});

// Hillshade Controls
document.getElementById('hillshade-toggle').addEventListener('change', function(e) {
    if (e.target.checked) {
        applyHillshadeSettings();
    } else {
        removeLayerIfExists('hillshade-layer');
    }
});

function applyHillshadeSettings() {
    const shadowColor = document.getElementById('hillshade-shadow-color').value;
    const highlightColor = document.getElementById('hillshade-highlight-color').value;
    const illumination = parseFloat(document.getElementById('hillshade-illumination').value);
    const exaggeration = parseFloat(document.getElementById('hillshade-exaggeration').value);
    
    removeLayerIfExists('hillshade-layer');
    
    map.addLayer({
        id: 'hillshade-layer',
        type: 'hillshade',
        source: 'mapbox-dem',
        paint: {
            'hillshade-shadow-color': shadowColor,
            'hillshade-highlight-color': highlightColor,
            'hillshade-illumination-direction': illumination,
            'hillshade-exaggeration': exaggeration
        }
    }, 'blm-all-fill');
}

['hillshade-shadow-color', 'hillshade-highlight-color', 'hillshade-illumination', 'hillshade-exaggeration'].forEach(id => {
    document.getElementById(id).addEventListener('input', function() {
        if (document.getElementById('hillshade-toggle').checked) {
            applyHillshadeSettings();
        }
    });
});

// Sky Controls
document.getElementById('sky-toggle').addEventListener('change', function(e) {
    if (e.target.checked) {
        applySkySettings();
    } else {
        removeLayerIfExists('sky');
    }
});

function applySkySettings() {
    const sunIntensity = parseFloat(document.getElementById('sky-sun-intensity').value);
    const sunX = parseFloat(document.getElementById('sky-sun-x').value);
    const sunY = parseFloat(document.getElementById('sky-sun-y').value);
    
    removeLayerIfExists('sky');
    
    map.addLayer({
        id: 'sky',
        type: 'sky',
        paint: {
            'sky-type': 'atmosphere',
            'sky-atmosphere-sun': [sunX, sunY],
            'sky-atmosphere-sun-intensity': sunIntensity
        }
    });
}

['sky-sun-intensity', 'sky-sun-x', 'sky-sun-y'].forEach(id => {
    document.getElementById(id).addEventListener('input', function() {
        if (document.getElementById('sky-toggle').checked) {
            applySkySettings();
        }
    });
});

// Fog Controls
document.getElementById('fog-toggle').addEventListener('change', function(e) {
    if (e.target.checked) {
        applyFogSettings();
    } else {
        map.setFog(null);
    }
});

function applyFogSettings() {
    const color = document.getElementById('fog-color').value;
    const horizonBlend = parseFloat(document.getElementById('fog-horizon-blend').value);
    const distance = parseFloat(document.getElementById('fog-distance').value);
    
    const rangeMin = 0.5;
    const rangeMax = 0.5 + (distance / 10);
    
    map.setFog({
        'color': color,
        'horizon-blend': horizonBlend,
        'range': [rangeMin, rangeMax]
    });
}

['fog-color', 'fog-horizon-blend', 'fog-distance'].forEach(id => {
    document.getElementById(id).addEventListener('input', function() {
        if (document.getElementById('fog-toggle').checked) {
            applyFogSettings();
        }
    });
});

// Helper function
function removeLayerIfExists(layerId) {
    if (map.getLayer(layerId)) {
        map.removeLayer(layerId);
    }
}

// Map Style Controls
document.getElementById('map-style-select').addEventListener('change', function(e) {
    const newStyle = e.target.value;
    const currentLayers = getCurrentLayerStates();
    
    map.setStyle(newStyle);
    
    // Re-add layers after style loads
    map.once('styledata', function() {
        // Re-add DEM source
        if (!map.getSource('mapbox-dem')) {
            map.addSource('mapbox-dem', {
                type: 'raster-dem',
                url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                tileSize: 512,
                maxzoom: 14
            });
        }
        
        // Re-apply terrain if enabled
        if (document.getElementById('terrain-toggle').checked) {
            const exaggeration = parseFloat(document.getElementById('terrain-exaggeration').value);
            map.setTerrain({ source: 'mapbox-dem', exaggeration: exaggeration });
        }
        
        // Re-add vector sources and layers
        addVectorLayers();
        
        // Restore layer states
        restoreLayerStates(currentLayers);
        
        // Re-apply custom effects
        if (document.getElementById('hillshade-toggle').checked) {
            applyHillshadeSettings();
        }
        if (document.getElementById('sky-toggle').checked) {
            applySkySettings();
        }
        if (document.getElementById('fog-toggle').checked) {
            applyFogSettings();
        }
    });
});

function getCurrentLayerStates() {
    return {
        blmAll: document.getElementById('toggle-blm-all').checked,
        fsAll: document.getElementById('toggle-fs-all').checked,
        blmSellable: document.getElementById('toggle-blm-sellable').checked,
        fsSellable: document.getElementById('toggle-fs-sellable').checked
    };
}

function restoreLayerStates(states) {
    if (map.getLayer('blm-all-fill')) {
        map.setLayoutProperty('blm-all-fill', 'visibility', states.blmAll ? 'visible' : 'none');
    }
    if (map.getLayer('fs-all-fill')) {
        map.setLayoutProperty('fs-all-fill', 'visibility', states.fsAll ? 'visible' : 'none');
    }
    if (map.getLayer('blm-sellable-stroke')) {
        map.setLayoutProperty('blm-sellable-stroke', 'visibility', states.blmSellable ? 'visible' : 'none');
    }
    if (map.getLayer('fs-sellable-stroke')) {
        map.setLayoutProperty('fs-sellable-stroke', 'visibility', states.fsSellable ? 'visible' : 'none');
    }
}

function addVectorLayers() {
    // Add vector tile sources
    if (!map.getSource('blm-all')) {
        map.addSource('blm-all', {
            type: 'vector',
            tiles: ['http://localhost:8080/data/blm_all_hires/{z}/{x}/{y}.pbf'],
            minzoom: 0,
            maxzoom: 14
        });
    }
    
    if (!map.getSource('fs-all')) {
        map.addSource('fs-all', {
            type: 'vector',
            tiles: ['http://localhost:8080/data/fs_all_hires/{z}/{x}/{y}.pbf'],
            minzoom: 0,
            maxzoom: 14
        });
    }
    
    if (!map.getSource('blm-sellable')) {
        map.addSource('blm-sellable', {
            type: 'vector',
            tiles: ['http://localhost:8080/data/blm_sellable_hires/{z}/{x}/{y}.pbf'],
            minzoom: 0,
            maxzoom: 14
        });
    }
    
    if (!map.getSource('fs-sellable')) {
        map.addSource('fs-sellable', {
            type: 'vector',
            tiles: ['http://localhost:8080/data/fs_sellable_hires/{z}/{x}/{y}.pbf'],
            minzoom: 0,
            maxzoom: 14
        });
    }

    // Add layers with current styling
    if (!map.getLayer('blm-all-fill')) {
        map.addLayer({
            id: 'blm-all-fill',
            type: 'fill',
            source: 'blm-all',
            'source-layer': 'blm_all',
            paint: {
                'fill-color': document.getElementById('blm-all-color').value,
                'fill-opacity': parseFloat(document.getElementById('blm-all-opacity').value)
            },
            layout: {
                'visibility': 'visible'
            }
        });
    }
    
    if (!map.getLayer('fs-all-fill')) {
        map.addLayer({
            id: 'fs-all-fill',
            type: 'fill',
            source: 'fs-all',
            'source-layer': 'fs_all',
            paint: {
                'fill-color': document.getElementById('fs-all-color').value,
                'fill-opacity': parseFloat(document.getElementById('fs-all-opacity').value)
            },
            layout: {
                'visibility': 'visible'
            }
        });
    }
    
    if (!map.getLayer('blm-sellable-stroke')) {
        map.addLayer({
            id: 'blm-sellable-stroke',
            type: 'line',
            source: 'blm-sellable',
            'source-layer': 'blm_sellable',
            paint: {
                'line-color': document.getElementById('blm-sellable-color').value,
                'line-width': parseFloat(document.getElementById('blm-sellable-width').value),
                'line-opacity': 0.8
            },
            layout: {
                'visibility': 'visible'
            }
        });
    }
    
    if (!map.getLayer('fs-sellable-stroke')) {
        map.addLayer({
            id: 'fs-sellable-stroke',
            type: 'line',
            source: 'fs-sellable',
            'source-layer': 'fs_sellable',
            paint: {
                'line-color': document.getElementById('fs-sellable-color').value,
                'line-width': parseFloat(document.getElementById('fs-sellable-width').value),
                'line-opacity': 0.8
            },
            layout: {
                'visibility': 'visible'
            }
        });
    }
}

// Layer Styling Controls
['blm-all-color', 'blm-all-opacity'].forEach(id => {
    document.getElementById(id).addEventListener('input', function() {
        if (map.getLayer('blm-all-fill')) {
            if (id.includes('color')) {
                map.setPaintProperty('blm-all-fill', 'fill-color', this.value);
                // Update color pip in layer controls
                const pip = document.querySelector('#toggle-blm-all + label .color-pip');
                if (pip) pip.style.backgroundColor = this.value;
                // Update text input
                const textInput = document.getElementById(id + '-text');
                if (textInput) textInput.value = this.value;
            } else {
                map.setPaintProperty('blm-all-fill', 'fill-opacity', parseFloat(this.value));
            }
        }
    });
});

// Add text input listeners for colors
document.getElementById('blm-all-color-text').addEventListener('input', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
        document.getElementById('blm-all-color').value = this.value;
        if (map.getLayer('blm-all-fill')) {
            map.setPaintProperty('blm-all-fill', 'fill-color', this.value);
            const pip = document.querySelector('#toggle-blm-all + label .color-pip');
            if (pip) pip.style.backgroundColor = this.value;
        }
    }
});

['fs-all-color', 'fs-all-opacity'].forEach(id => {
    document.getElementById(id).addEventListener('input', function() {
        if (map.getLayer('fs-all-fill')) {
            if (id.includes('color')) {
                map.setPaintProperty('fs-all-fill', 'fill-color', this.value);
                // Update color pip in layer controls
                const pip = document.querySelector('#toggle-fs-all + label .color-pip');
                if (pip) pip.style.backgroundColor = this.value;
                // Update text input
                const textInput = document.getElementById(id + '-text');
                if (textInput) textInput.value = this.value;
            } else {
                map.setPaintProperty('fs-all-fill', 'fill-opacity', parseFloat(this.value));
            }
        }
    });
});

document.getElementById('fs-all-color-text').addEventListener('input', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
        document.getElementById('fs-all-color').value = this.value;
        if (map.getLayer('fs-all-fill')) {
            map.setPaintProperty('fs-all-fill', 'fill-color', this.value);
            const pip = document.querySelector('#toggle-fs-all + label .color-pip');
            if (pip) pip.style.backgroundColor = this.value;
        }
    }
});

['blm-sellable-color', 'blm-sellable-width'].forEach(id => {
    document.getElementById(id).addEventListener('input', function() {
        if (map.getLayer('blm-sellable-stroke')) {
            if (id.includes('color')) {
                map.setPaintProperty('blm-sellable-stroke', 'line-color', this.value);
                // Update color pip in layer controls
                const pip = document.querySelector('#toggle-blm-sellable + label .color-pip');
                if (pip) pip.style.borderColor = this.value;
                // Update text input
                const textInput = document.getElementById(id + '-text');
                if (textInput) textInput.value = this.value;
            } else {
                map.setPaintProperty('blm-sellable-stroke', 'line-width', parseFloat(this.value));
            }
        }
    });
});

document.getElementById('blm-sellable-color-text').addEventListener('input', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
        document.getElementById('blm-sellable-color').value = this.value;
        if (map.getLayer('blm-sellable-stroke')) {
            map.setPaintProperty('blm-sellable-stroke', 'line-color', this.value);
            const pip = document.querySelector('#toggle-blm-sellable + label .color-pip');
            if (pip) pip.style.borderColor = this.value;
        }
    }
});

['fs-sellable-color', 'fs-sellable-width'].forEach(id => {
    document.getElementById(id).addEventListener('input', function() {
        if (map.getLayer('fs-sellable-stroke')) {
            if (id.includes('color')) {
                map.setPaintProperty('fs-sellable-stroke', 'line-color', this.value);
                // Update color pip in layer controls
                const pip = document.querySelector('#toggle-fs-sellable + label .color-pip');
                if (pip) pip.style.borderColor = this.value;
                // Update text input
                const textInput = document.getElementById(id + '-text');
                if (textInput) textInput.value = this.value;
            } else {
                map.setPaintProperty('fs-sellable-stroke', 'line-width', parseFloat(this.value));
            }
        }
    });
});

document.getElementById('fs-sellable-color-text').addEventListener('input', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
        document.getElementById('fs-sellable-color').value = this.value;
        if (map.getLayer('fs-sellable-stroke')) {
            map.setPaintProperty('fs-sellable-stroke', 'line-color', this.value);
            const pip = document.querySelector('#toggle-fs-sellable + label .color-pip');
            if (pip) pip.style.borderColor = this.value;
        }
    }
});
</script>

</body>
</html> 